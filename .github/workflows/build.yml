name: Build GeoIP and GeoSite

on:
  schedule:
    - cron: '0 0 */3 * *'  # Run every 3 days at 00:00 UTC
  workflow_dispatch:  # Allow manual trigger
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - '.gitignore'

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Set release tag
        id: tag
        run: |
          TAG=$(date +'%Y%m%d')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"
      
      - name: Download source files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/fetch_sources.py
      
      - name: Parse whitelist data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/parse_whitelist.py
      
      - name: Merge categories into geoip.dat
        run: |
          python scripts/merge_geoip.py
      
      - name: Merge categories into geosite.dat
        run: |
          python scripts/merge_geosite.py
      
      - name: Verify output files
        run: |
          if [ ! -f output/geoip.dat ]; then
            echo "ERROR: geoip.dat not found"
            exit 1
          fi
          if [ ! -f output/geosite.dat ]; then
            echo "ERROR: geosite.dat not found"
            exit 1
          fi
          echo "geoip.dat size: $(stat -c%s output/geoip.dat) bytes"
          echo "geosite.dat size: $(stat -c%s output/geosite.dat) bytes"
          
      - name: Update LastUpdated timestamp
        run: |
          TIMESTAMP=$(date +%s)
          python3 << EOF
          import json
          
          with open('JSON.DEFAULT', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          data['LastUpdated'] = "$TIMESTAMP"
          
          with open('JSON.DEFAULT', 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          
          print(f"Updated LastUpdated to $TIMESTAMP")
          EOF
          
- name: Generate HAPP deeplink (only if changed)
  run: |
    BASE64_CONFIG=$(base64 -w 0 JSON.DEFAULT)
    NEW_LINK="happ://routing/onadd/${BASE64_CONFIG}"

    # Если файла нет — создаём
    if [ ! -f HAPP_DEEPLINK ]; then
      echo "$NEW_LINK" > HAPP_DEEPLINK
      echo "HAPP_DEEPLINK created"
      exit 0
    fi

    # Считываем текущее содержимое
    CURRENT_LINK=$(cat HAPP_DEEPLINK)

    # Сравниваем
    if [ "$CURRENT_LINK" != "$NEW_LINK" ]; then
      echo "$NEW_LINK" > HAPP_DEEPLINK
      echo "HAPP_DEEPLINK updated"
    else
      echo "No changes detected"
    fi
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            # Release ${{ steps.tag.outputs.tag }}
            
            `geoip.dat` и `geosite.dat` с whitelist категориями из российских источников.
            
            **Категории:**
            - **WHITELIST** (GeoIP) - IP адреса
            - **WHITELIST-RU** (GeoSite) - Российские домены
            - **WHITELIST-ADS** (GeoSite) - Рекламные домены
            
            **Использование:** см. [README](https://github.com/1nFern0-git/RU-whitelist-routing#readme)
          files: |
            output/geoip.dat
            output/geosite.dat
          draft: false
          prerelease: false
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add JSON.DEFAULT
          git commit -m "chore: Update LastUpdated timestamp [${{ steps.tag.outputs.tag }}]" || echo "No changes to commit"
          git push
