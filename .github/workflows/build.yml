name: Build GeoIP & GeoSite with Whitelist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 */3 * *'  # –ö–∞–∂–¥—ã–µ 3 –¥–Ω—è
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'LICENSE'

permissions:
  contents: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      # === CHECKOUT ===
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # === SETUP ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests

      # === GEOIP PROCESSING ===
      - name: Checkout v2fly/geoip
        uses: actions/checkout@v4
        with:
          repository: v2fly/geoip
          path: geoip-builder
          fetch-depth: 1

      - name: Set up Go for GeoIP
        uses: actions/setup-go@v5
        with:
          go-version-file: geoip-builder/go.mod
          cache-dependency-path: geoip-builder/go.sum

      - name: Download base geoip.dat from hydraponique
        run: |
          mkdir -p downloads
          curl -fsSL -o downloads/geoip-base.dat \
            https://github.com/hydraponique/roscomvpn-geoip/releases/latest/download/geoip.dat
          echo "Downloaded base geoip.dat: $(du -h downloads/geoip-base.dat)"

      - name: Fetch whitelist IPs
        run: python scripts/fetch_whitelist_ips.py

      - name: Prepare GeoIP config
        run: |
          cp configs/geoip-config.json geoip-builder/config.json
          cp data/whitelist-ips.txt geoip-builder/

      - name: Build GeoIP with WHITELIST category
        working-directory: geoip-builder
        run: |
          go run ./ --config=config.json
          mkdir -p ../output
          mv output/dat/geoip.dat ../output/geoip.dat

      # === GEOSITE PROCESSING ===
      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: geosite-builder
          fetch-depth: 1

      - name: Set up Go for GeoSite
        uses: actions/setup-go@v5
        with:
          go-version-file: geosite-builder/go.mod
          cache-dependency-path: geosite-builder/go.sum

      - name: Download base geosite.dat from hydraponique
        run: |
          curl -fsSL -o downloads/geosite-base.dat \
            https://github.com/hydraponique/roscomvpn-geosite/releases/latest/download/geosite.dat
          echo "Downloaded base geosite.dat: $(du -h downloads/geosite-base.dat)"

      - name: Fetch whitelist domains
        run: python scripts/fetch_whitelist_domains.py

      - name: Prepare GeoSite data
        run: |
          rm -rf geosite-builder/data
          mkdir -p geosite-builder/data
          
          # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à–∏ whitelist –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          cp data/whitelist-ru geosite-builder/data/
          cp data/whitelist-ads geosite-builder/data/

      - name: Build GeoSite with WHITELIST categories
        working-directory: geosite-builder
        run: |
          mkdir -p ../output
          go run ./ --datapath=./data --outputdir=../output
          # v2fly/domain-list-community outputs dlc.dat
          mv ../output/dlc.dat ../output/geosite-whitelist.dat

      # === MERGE WITH BASE FILES ===
      - name: Merge with base geosite.dat
        run: |
          # Concatenate base geosite.dat with our whitelist categories
          # This works because protobuf repeated fields can be appended
          cat downloads/geosite-base.dat output/geosite-whitelist.dat > output/geosite.dat
          rm output/geosite-whitelist.dat

      # === RELEASE ===
      - name: Set release tag
        run: |
          RELEASE_TAG=$(date +%Y%m%d)
          echo "RELEASE_TAG=$RELEASE_TAG" >> "$GITHUB_ENV"

      - name: Verify output files
        run: |
          ls -lh output/
          echo "geoip.dat size: $(du -h output/geoip.dat | cut -f1)"
          echo "geosite.dat size: $(du -h output/geosite.dat | cut -f1)"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          body: |
            ## GeoIP & GeoSite —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ Whitelist
            
            –†–µ–ª–∏–∑ –æ—Ç **${{ env.RELEASE_TAG }}**
            
            ### üì¶ –í–∫–ª—é—á–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
            
            **geoip.dat:**
            - –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç [hydraponique/roscomvpn-geoip](https://github.com/hydraponique/roscomvpn-geoip)
            - `WHITELIST` - IP-–∞–¥—Ä–µ—Å–∞ –∏–∑ kirilllavrov/RU-domain-list-for-whitelist
            
            **geosite.dat:**
            - –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç [hydraponique/roscomvpn-geosite](https://github.com/hydraponique/roscomvpn-geosite)
            - `WHITELIST-RU` - –†–æ—Å—Å–∏–π—Å–∫–∏–µ –¥–æ–º–µ–Ω—ã
            - `WHITELIST-ADS` - –†–µ–∫–ª–∞–º–Ω—ã–µ –¥–æ–º–µ–Ω—ã
            
            ### üì• –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
            
            ```json
            // Xray/V2Ray
            {
              "routing": {
                "rules": [
                  {
                    "type": "field",
                    "ip": ["geoip:whitelist"],
                    "outboundTag": "direct"
                  },
                  {
                    "type": "field",
                    "domain": ["geosite:whitelist-ru", "geosite:whitelist-ads"],
                    "outboundTag": "direct"
                  }
                ]
              }
            }
            ```
            
            ### üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
            - [hydraponique/roscomvpn-geoip](https://github.com/hydraponique/roscomvpn-geoip)
            - [hydraponique/roscomvpn-geosite](https://github.com/hydraponique/roscomvpn-geosite)
            - [kirilllavrov/RU-domain-list-for-whitelist](https://github.com/kirilllavrov/RU-domain-list-for-whitelist)
          files: |
            output/geoip.dat
            output/geosite.dat
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
